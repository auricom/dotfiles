{{- if .desktop -}}
#!/usr/bin/env bash

# Git repositories management script
# Clones and configures git repositories
# Hash dependencies: {{ include ".chezmoidata/repositories.yaml" | sha256sum }}

set -euo pipefail

# Source utility functions
source "{{ .chezmoi.homeDir }}/scripts/lib/chezmoi_utils.sh"

main() {
    log_section "Managing git repositories"

    # Clone repositories
    clone_repositories

    # Set up symlinks
    setup_symlinks

    log_info "Git repositories setup completed"
}

clone_repositories() {
    log_info "Cloning git repositories"

    {{- range $user, $repos := .repositories }}
    {{- range $repos }}
    git_clone_if_missing \
        "git@github.com:{{ $user }}/{{ . }}.git" \
        "{{ $.chezmoi.homeDir }}/repositories/{{ $user }}/{{ . }}"
    {{- end }}
    {{- end }}
}

setup_symlinks() {
    log_info "Setting up symlinks"

    {{- range $name, $symlink := .symlinks }}
    create_symlink_if_missing \
        "{{ $.chezmoi.homeDir }}/{{ $symlink.source }}" \
        "{{ $.chezmoi.homeDir }}/{{ $symlink.target }}"
    {{- end }}
}

# Run main function
main "$@"
{{- end -}}
