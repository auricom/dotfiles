{{- if .desktop -}}
#!/usr/bin/env bash

# Systemd services management script
# Manages user systemd services and quadlets

set -euo pipefail

# Source utility functions
source "{{ .chezmoi.homeDir }}/scripts/lib/chezmoi_utils.sh"

# Hash dependencies for change detection
# doftiles_update_custom service: {{ include "private_dot_config/systemd/user/dotfiles-update-custom.service.tmpl" | sha256sum }}
# dotfiles_update_custom timer: {{ include "private_dot_config/systemd/user/dotfiles-update-custom.timer.tmpl" | sha256sum }}
# resilio-sync hash: {{ include "private_dot_config/containers/systemd/resilio-sync.container.tmpl" | sha256sum }}

main() {
    log_section "Managing systemd services and quadlets"

    # Reload systemd daemon to pick up new/changed units
    log_info "Reloading systemd user daemon"
    systemctl --user daemon-reload

    # Enable and start dotfiles-update-custom timer
    systemd_enable_start "dotfiles-update-custom.timer"

    # Enable container services if they exist
    enable_container_services

    log_info "Systemd configuration completed"
}

enable_container_services() {
    local services=(
        "resilio-sync.service"
    )

    for service in "${services[@]}"; do
        if systemctl --user list-unit-files | grep -q "$service"; then
            log_info "Found container service: $service"
            systemd_enable_start "$service"
        else
            log_debug "Container service not found: $service"
        fi
    done
}

# Run main function
main "$@"
{{- end -}}
