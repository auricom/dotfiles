{{- if .desktop -}}
#!/usr/bin/env bash

# Systemd services management script
# Manages user systemd services and quadlets

set -euo pipefail

# Source utility functions
source "{{ .chezmoi.homeDir }}/scripts/lib/chezmoi_utils.sh"

# Hash dependencies for change detection
# dotfiles-update service: {{ include "private_dot_config/systemd/user/dotfiles-update.service" | sha256sum }}
# dotfiles-update timer: {{ include "private_dot_config/systemd/user/dotfiles-update.timer" | sha256sum }}
# fisher-update service: {{ include "private_dot_config/systemd/user/fisher-update.service" | sha256sum }}
# fisher-update timer: {{ include "private_dot_config/systemd/user/fisher-update.timer" | sha256sum }}
# notify-failure hash: {{ include "private_dot_config/systemd/user/notify-failure@.service" | sha256sum }}
# resilio-sync hash: {{ include "private_dot_config/containers/systemd/resilio-sync.container.tmpl" | sha256sum }}

# Services to enable and start
SERVICES=(
    "dotfiles-update.timer"
    "fisher-update.timer"
)

# Container services to enable and start (only if unit exists)
CONTAINER_SERVICES=(
    "resilio-sync.service"
)

main() {
    log_section "Managing systemd services and quadlets"

    # Reload systemd daemon to pick up new/changed units
    log_info "Reloading systemd user daemon"
    systemctl --user daemon-reload

    enable_system_services
    enable_container_services

    log_info "Systemd configuration completed"
}

enable_system_services() {
    for service in "${SERVICES[@]}"; do
        systemd_enable_start "$service"
    done
}

enable_container_services() {
    for service in "${CONTAINER_SERVICES[@]}"; do
        if systemctl --user list-unit-files | grep -q "$service"; then
            log_info "Found container service: $service"
            systemd_enable_start "$service"
        else
            log_debug "Container service not found: $service"
        fi
    done
}

# Run main function
main "$@"
{{- end -}}
