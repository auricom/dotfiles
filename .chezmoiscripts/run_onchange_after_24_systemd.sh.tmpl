{{- if .desktop -}}
#!/usr/bin/env bash

# Systemd services management script
# Manages user systemd services and quadlets

set -euo pipefail

# Source utility functions
source "{{ .chezmoi.homeDir }}/.local/lib/chezmoi_utils.sh"

# Hash dependencies for change detection
# dotfiles-update service: {{ include "private_dot_config/systemd/user/dotfiles-update.service" | sha256sum }}
# dotfiles-update timer: {{ include "private_dot_config/systemd/user/dotfiles-update.timer" | sha256sum }}
# fisher-update service: {{ include "private_dot_config/systemd/user/fisher-update.service" | sha256sum }}
# fisher-update timer: {{ include "private_dot_config/systemd/user/fisher-update.timer" | sha256sum }}
# notify-failure hash: {{ include "private_dot_config/systemd/user/notify-failure@.service" | sha256sum }}
# resilio-sync hash: {{ include "private_dot_config/containers/systemd/resilio-sync.container.tmpl" | sha256sum }}

main() {
    log_section "Managing systemd services and quadlets"

    # Reload systemd daemon to pick up new/changed units
    log_info "Reloading systemd user daemon"
    systemctl --user daemon-reload

    enable_system_services
    enable_container_services

    log_info "Systemd configuration completed"
}

enable_system_services() {
    local unit_dir="$HOME/.config/systemd/user"
    local -A has_timer=()

    # Collect timer units (skip templates containing @)
    for f in "$unit_dir"/*.timer; do
        [[ -f "$f" ]] || continue
        local name
        name=$(basename "$f" .timer)
        [[ "$name" == *"@"* ]] && continue
        has_timer["$name"]=1
        log_info "Found timer: ${name}.timer"
        systemd_enable_start "${name}.timer"
    done

    # Enable services that have no corresponding timer (skip templates)
    for f in "$unit_dir"/*.service; do
        [[ -f "$f" ]] || continue
        local name
        name=$(basename "$f" .service)
        [[ "$name" == *"@"* ]] && continue
        [[ -v has_timer["$name"] ]] && continue
        log_info "Found service: ${name}.service"
        systemd_enable_start "${name}.service"
    done
}

enable_container_services() {
    local container_dir="$HOME/.config/containers/systemd"
    [[ -d "$container_dir" ]] || return 0

    for f in "$container_dir"/*.container "$container_dir"/*.network "$container_dir"/*.volume; do
        [[ -f "$f" ]] || continue
        local base service
        base=$(basename "$f")
        service="${base%%.*}.service"
        if systemctl --user list-unit-files | grep -q "^${service}"; then
            log_info "Found container service: $service"
            systemd_enable_start "$service"
        else
            log_debug "Container service not found: $service"
        fi
    done
}

# Run main function
main "$@"
{{- end -}}
