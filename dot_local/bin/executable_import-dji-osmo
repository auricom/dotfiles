#!/bin/bash

set -Eeuo pipefail

source "${HOME}/.local/lib/chezmoi_utils.sh"

# Source and destination directories
DJI_SOURCE_DIR="/run/media/auricom/SD_Card/DCIM"
SORT_DEST_DIR="/var/mnt/storage.feisar.ovh/photo"

# Validate required directories
[[ -d "${DJI_SOURCE_DIR}" ]] || { log_error "Source not mounted" path="${DJI_SOURCE_DIR}"; exit 1; }
[[ -d "${SORT_DEST_DIR}" ]]  || { log_error "Destination not mounted" path="${SORT_DEST_DIR}"; exit 1; }

# Process a single DJI file
process_dji_file() {
    local file="$1"
    local filename
    filename="$(basename "${file}")"

    log_debug "Processing: ${filename}"

    if [[ "${filename}" =~ DJI_([0-9]{4})([0-9]{2})([0-9]{2})([0-9]{6})_.*\..* ]]; then
        local year="${BASH_REMATCH[1]}"
        local month="${BASH_REMATCH[2]}"
        local day="${BASH_REMATCH[3]}"
        local dest_path="${SORT_DEST_DIR}/${year}/${year}-${month}/${year}-${month}-${day}"
        local dest_file="${dest_path}/${filename}"

        mkdir -p "${dest_path}"

        if [[ ! -f "${dest_file}" ]]; then
            run_spin "Copying ${filename}…" cp "${file}" "${dest_file}"
            log_info "Copied ${filename}"
        else
            local src_size dest_size
            src_size="$(stat -c %s "${file}")"
            dest_size="$(stat -c %s "${dest_file}")"

            if [[ "${src_size}" -eq "${dest_size}" ]]; then
                log_debug "Already exists: ${filename}"
            else
                run_spin "Updating ${filename}…" cp "${file}" "${dest_file}"
                log_warn "Updated ${filename} (${dest_size} → ${src_size} bytes)"
            fi
        fi
    else
        log_debug "Skipping: not a DJI filename: ${filename}"
    fi
}

log_section "DJI Osmo Import"

while IFS= read -r -d '' dji_dir; do
    log_info "Directory: $(basename "${dji_dir}")"
    while IFS= read -r -d '' file; do
        process_dji_file "${file}"
    done < <(find "${dji_dir}" -type f -print0)
done < <(find "${DJI_SOURCE_DIR}" -type d -name "DJI_*" -print0)

log_info "Import complete"
